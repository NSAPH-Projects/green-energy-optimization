---
title: "DistributedLag_group_control-demand"
author: "Arpita"
date: '2023-05-11'
output: html_document
---

```{r}
#install.packages("lubridate")
library(data.table)
library(lubridate)
library(dplyr)
library(tidyr)
```

```{r}
#devtools::install_github("danielmork/dlmtree", ref="development")
library(ggplot2)
library(ggpubr)
library(dlmtree)
library(splines)
library(readxl)
```

```{r}
setwd("/n/dominici_lab/lab/fossil_fuel_energy/data/")
countries <- c('CAL', 'SW')
data_list <- list()
lag_data_list <- list()
lead_data_list <- list()
complete_list <- list()
for (i in range(1:length(countries))){

  data <- read_xlsx(paste("energy/Region_", countries[i], ".xlsx", sep=""), guess_max = 50000)
  setDT(data)
  data <- data[!is.na(`NG: SUN`)]
  data <- data[!which('NG..SUN'<0)]
  data[, date2 := as_date(`Local date`)]
  data[, dow := wday(date2)]
  data[, week := week(date2)]
  data[, month := month(date2)]
  data[, year := year(date2)]
  data[, demand := `D`]
  data[, index := 1:.N]
  
  # Make column names safe for use in formulas
  setnames(data, make.names(names(data)))
  print(colnames(data))
  
  
  # Create lagged data
  lags <- 10
  lag_dat <- as.matrix(data[, shift(NG..SUN, 0:10, type = "lag")])
  #lead_dat <- as.matrix(data[, shift(NG..SUN, 10:1, type = "lead")])
  #lag_dat <- cbind(lead_dat, lag_dat)
  # data[, demand_ma10 := rollmean(demand, k = 10)] -- CHECK! 
  # Complete data rows
  
  data_list[[i]]<-data
  lag_data_list[[i]]<- lag_dat
  #lead_data_list[[i]]<-lead_dat
  complete_list[[i]] <- which(complete.cases(lag_dat) & 
                            complete.cases(data[, .(CO2.Emissions.Generated, demand)]))


  
}
```

```{r}
# Individual Nonlinear lagged model

dlnm_mod_list<-list()
for (i in range(1:length(countries))){
  data <- data_list[[i]]
  complete <- complete_list[[i]]
  lag_dat <- lag_data_list[[i]]
  set.seed(6757+i)
  dlnm_mod_list[[i]] <- combine.models(lapply(1:10, function(j) {
                                tdlnm(I(-1*CO2.Emissions.Generated) ~ ns(index, df = 24) * ns(Hour, df = 4) + demand,       
                                              data[complete],
                                              exposure.data = lag_dat[complete,],
                                              exposure.splits = seq(quantile(lag_dat[complete,], .05), quantile(lag_dat[complete,], .95), length.out = 10), #5%and 95% percentile
                                              #n.burn = 500, n.iter = 1000,
                                              monotone = T,
                                              time.split.prob = rep(c(10, 1), c(4, 6)))
  }))
  save(dlnm_mod_list,file="dlnm_mod_list.Rda")
}

```

```{r}
save(dlnm_mod_list,file="dlnm_mod_list.Rda")
```

```{r}
load("dlnm_mod_list.Rda")
```

```{r}

for (i in range(1:length(countries))){
  dlnm_mod <- dlnm_mod_list[[i]]
  
  s_dlnm_mod <- summary(dlnm_mod, cenval = 0, conf.level = .9)
  jpeg(paste("lineplot_",countries[i],".jpg", sep=""))
  plot(0:lags, s_dlnm_mod$splitProb, type = 'l', ylim = 0:1,
       main = paste(countries[i], " Region", sep=""),
       xlab = "Hours lead (-) / lag (+)", ylab = "Prob effect"); abline(h = 0.95, lty = 2)
  dev.off()
}
```

```{r}
for (i in range(1:length(countries))){
  dlnm_mod <- dlnm_mod_list[[i]]
  
  s_dlnm_mod <- summary(dlnm_mod, cenval = 0, conf.level = .9)
  jpeg(paste("heatmap_",countries[i],".jpg", sep=""))
  plot(s_dlnm_mod, start.time = -lags,
     xlab = "Lag hour",
     ylab = "Solar generation",
     flab = "Decreased CO2",
     main = paste(countries[i], " Region", sep=""))
  dev.off()
}
```

```{r}
y_upper_list<- c(1000,200)
for (i in range(1:length(countries))){
  dlnm_mod <- dlnm_mod_list[[i]]
  
  s_dlnm_mod <- summary(dlnm_mod, cenval = 0, conf.level = .9)
  jpeg(paste("continuous_",countries[i],".jpg", sep="")) 
  p2 <- plot(s_dlnm_mod, "slice", time = 0, start.time = -lags,
             xlab = "Solar generation", ylab = "Decrease in CO2 generation",
             main = "Same time") + scale_y_continuous(limits=c(-200,y_upper_list[i]))
  p3 <- plot(s_dlnm_mod, "slice", time = 1, start.time = -lags,
             xlab = "", ylab = "", 
             main = "1 hour lag") + scale_y_continuous(limits=c(-200,y_upper_list[i]))
  p4 <- plot(s_dlnm_mod, "slice", time = 2, start.time = -lags,
             xlab = "", ylab = "", 
             main = "2 hours lag") + scale_y_continuous(limits=c(-200,y_upper_list[i]))
  p5 <- plot(s_dlnm_mod, "slice", time = 3, start.time = -lags,
             xlab = "", ylab = "", 
             main = "3 hours lag") + scale_y_continuous(limits=c(-200,y_upper_list[i]))
  ggarrange(p2, p3, p4,p5)
  dev.off()
}
```

```{r}
#Group of countries
countries <- c("CAL", "SW")
modified_data_list<- list()

#For each region, adjust the trade exchange value
for (i in range(1:length(countries))){
  d<- data_list[[i]]
  d$D_new<- d$D
  for (j in range(1:length(countries))){
    d<- d %>% mutate_at(c(paste(countries[j])), ~replace_na(.,0))
    d$D_new <- d$D_new + d[[countries[j]]]
  }
  modified_data_list[[i]]<-d
}
```

```{r}
#Create one merged file
#Merge using the UTC time and not Local Time
combo <- modified_data_list[[1]]
combo <- combo[, c("Local.date", "Hour", "D_new", "NG..SUN", "CO2.Emissions.Generated")]
for (i in range(2:length(countries))){
  combo<-merge(combo, modified_data_list[i], by=c("UTC.time"))
  combo$Local.date <- combo$Local.date.x
  combo$Hour <- combo$Hour.x
  combo$D<- combo$D.y
  combo$NG..SUN<- combo$NG..SUN.x
  combo$CO2.Emissions.Generated <- combo$CO2.Emissions.Generated.y
  combo <- combo[, c("Local.date", "Hour", "D", "NG..SUN", "CO2.Emissions.Generated")]
}
```

```{r}
data <- combo
setDT(data)
data <- data[!is.na(`NG..SUN`)]
data[, date2 := as_date(`Local.date`)]
data[, dow := wday(date2)]
data[, week := week(date2)]
data[, month := month(date2)]
data[, year := year(date2)]
data[, demand := `D`]
data[, index := 1:.N]

# Make column names safe for use in formulas
setnames(data, make.names(names(data)))
print(colnames(data))


# Create lagged data
lags <- 10
lag_dat <- as.matrix(data[, shift(NG..SUN, 0:10, type = "lag")])
#lead_dat <- as.matrix(data[, shift(NG..SUN, 10:1, type = "lead")])
#lag_dat <- cbind(lead_dat, lag_dat)
complete<- which(complete.cases(lag_dat) & 
                            complete.cases(data[, .(CO2.Emissions.Generated, demand)]))

dlnm_mod <- tdlnm(I(-1*CO2.Emissions.Generated) ~ ns(index, df = 24) * ns(Hour, df = 4) + demand,       
            data[complete],
            exposure.data = lag_dat[complete,],
            exposure.splits = seq(200, 2000, length.out = 10),
            #n.burn = 500, n.iter = 1000,
            monotone = T,
            time.split.prob = rep(c(1, 10, 1), c(6, 7, 6)))

save(dlnm_mod,file=paste("dlnm_mod_",paste(countries, collapse="_"),".Rda", sep=""))

```
```{r}
save(dlnm_mod,file=paste("dlnm_mod_",paste(countries, collapse="_"),".Rda", sep=""))
```

```{r}
load(paste("dlnm_mod_",paste(countries, collapse="_"),".Rda", sep=""))
s_dlnm_mod <- summary(dlnm_mod, cenval = 0, conf.level = .9)

#lineplot 
jpeg(paste("lineplot_",paste(countries, collapse="_"),".jpg", sep=""))
plot((-lags):lags, s_dlnm_mod$splitProb, type = 'l', ylim = 0:1,
     main = paste(countries, collapse="_"),
     xlab = "Hours lead (-) / lag (+)", ylab = "Prob effect"); abline(h = 0.95, lty = 2)
dev.off()

#heatmap
jpeg(paste("heatmap_",paste(countries, collapse="_"),".jpg", sep=""))
plot(s_dlnm_mod, start.time = -lags,
   xlab = "Lag hour",
   ylab = "Solar generation",
   flab = "Decreased CO2",
   main = paste(countries, collapse="_"))
dev.off()

#lagged plots
jpeg(paste("continuous_",paste(countries, collapse="_"),".jpg", sep="")) 
p2 <- plot(s_dlnm_mod, "slice", time = 0, start.time = -lags,
           xlab = "Solar generation", ylab = "Decrease in CO2 generation",
           main = "Same time") + scale_y_continuous(limits=c(-200,5000))
p3 <- plot(s_dlnm_mod, "slice", time = 1, start.time = -lags,
           xlab = "", ylab = "", 
           main = "1 hour lag") + scale_y_continuous(limits=c(-200,5000))
p4 <- plot(s_dlnm_mod, "slice", time = 2, start.time = -lags,
           xlab = "", ylab = "", 
           main = "2 hours lag") + scale_y_continuous(limits=c(-200,5000))
p5 <- plot(s_dlnm_mod, "slice", time = 3, start.time = -lags,
           xlab = "", ylab = "", 
           main = "3 hours lag") + scale_y_continuous(limits=c(-200,5000))
ggarrange(p2, p3, p4,p5)
dev.off()
```

```{r}
#One country's CO2 reduction based on the "base" country
base_country <- "SW"
other_country <- "CAL"

#For other country, adjust the trade exchange value
d <- data_list[[2]]

#d<- d %>% mutate_at(c(paste(other_country)), ~replace_na(.,0))
#d$D_new <- d$D_new + d[[other_country]]
```

```{r}
#Create one merged file
combo <- d
combo <- combo[, c("UTC.time", "D", "NG..SUN", "CO2.Emissions.Generated")]

combo<-merge(combo, data_list[[1]], by=c("UTC.time"))
combo$D<- combo$D.y
combo$NG..SUN<- combo$NG..SUN.x #+ combo$NG..SUN.y
combo$CO2.Emissions.Generated <- combo$CO2.Emissions.Generated.y
combo <- combo[, c("Local.date", "Hour", "D", "NG..SUN", "CO2.Emissions.Generated")]
```

```{r}
data <- combo
setDT(data)
data <- data[!is.na(`NG..SUN`)]

data[, date2 := as_date(`Local.date`)]
data[, dow := wday(date2)]
data[, week := week(date2)]
data[, month := month(date2)]
data[, year := year(date2)]
data[, demand := `D`]
data[, index := 1:.N]

# Make column names safe for use in formulas
setnames(data, make.names(names(data)))
print(colnames(data))


# Create lagged data
lags <- 10
lag_dat <- as.matrix(data[, shift(NG..SUN, 0:10, type = "lag")])
#lead_dat <- as.matrix(data[, shift(NG..SUN, 10:1, type = "lead")])
#lag_dat <- cbind(lead_dat, lag_dat)
complete<- which(complete.cases(lag_dat) & 
                            complete.cases(data[, .(CO2.Emissions.Generated, demand)]))

dlnm_mod_directed <- combine.models(lapply(1:2, function(j) {
                                tdlnm(I(-1*CO2.Emissions.Generated) ~ ns(index, df = 24) * ns(Hour, df = 4) + demand,       
                                              data[complete],
                                              exposure.data = lag_dat[complete,],
                                              exposure.splits = seq(quantile(lag_dat[complete,], .05), quantile(lag_dat[complete,], .95), length.out = 10), #5%and 95% percentile
                                              #n.burn = 500, n.iter = 1000,
                                              monotone = T,
                                              time.split.prob = rep(c(10, 1), c(4, 6)))
  }))

save(dlnm_mod_directed,file=paste("dlnm_mod_directed_",paste(countries, collapse="_"),".Rda", sep=""))

```

```{r}
load(paste("dlnm_mod_directed_",paste(countries, collapse="_"),".Rda", sep=""))
s_dlnm_mod <- summary(dlnm_mod_directed, cenval = 0, conf.level = .9)

#lineplot 
jpeg(paste("lineplot_directed_",paste(countries, collapse="_"),".jpg", sep=""))
plot(0:lags, s_dlnm_mod$splitProb, type = 'l', ylim = 0:1,
     main = paste(countries, collapse="_"),
     xlab = "lag (+)", ylab = "Prob effect"); abline(h = 0.95, lty = 2)
dev.off()

#heatmap
jpeg(paste("heatmap_directed_",paste(countries, collapse="_"),".jpg", sep=""))
plot(s_dlnm_mod, start.time = 0,
   xlab = "Lag hour",
   ylab = "Solar generation",
   flab = "Decreased CO2",
   main = paste(countries, collapse="_"))
dev.off()

#lagged plots
jpeg(paste("continuous_directed_",paste(countries, collapse="_"),".jpg", sep="")) 
p2 <- plot(s_dlnm_mod, "slice", time = 0, start.time = -lags,
           xlab = "Solar generation", ylab = "Decrease in CO2 generation",
           main = "Same time") + scale_y_continuous(limits=c(-200,5000))
p3 <- plot(s_dlnm_mod, "slice", time = 1, start.time = -lags,
           xlab = "", ylab = "", 
           main = "1 hour lag") + scale_y_continuous(limits=c(-200,5000))
p4 <- plot(s_dlnm_mod, "slice", time = 2, start.time = -lags,
           xlab = "", ylab = "", 
           main = "2 hours lag") + scale_y_continuous(limits=c(-200,5000))
p5 <- plot(s_dlnm_mod, "slice", time = 3, start.time = -lags,
           xlab = "", ylab = "", 
           main = "3 hours lag") + scale_y_continuous(limits=c(-200,5000))
ggarrange(p2, p3, p4,p5)
dev.off()
```
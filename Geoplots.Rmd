---
title: "Geoplots"
author: "Arpita"
date: "2023-06-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
library(lubridate)
library(dplyr)
library(tidyr)
library(readxl)
```

```{r}
countries <- c('CAR', 'CENT', 'FlA', 'MIDA', 'MIDW', 'NE', 'NW', 'NY', 'SE', 'SW', 'TEN', 'TEX', "CAL")

findAvgSolar<- function(start_date, end_date){
  avgSolar<- list()
  for (i in 1:length(countries)){
    country = countries[i]
    print(country)
    #Read file and extract data
    data <- read_xlsx(paste("/n/dominici_lab/lab/fossil_fuel_energy/data/energy/Region_", countries[i], ".xlsx", sep=""), guess_max = 700000)
    print("finish reading")
    print(nrow(data))
    setDT(data)
    data <- data[!is.na(`NG: SUN`)]
    data <- data[!which('NG..SUN'<0)]
    data <- data[!which('CO2.Emissions.Generated'>=0)]
    data[, date2 := as_date(`Local date`)]
    data[, dow := wday(date2)]
    data[, week := week(date2)]
    data[, month := month(date2)]
    data[, year := year(date2)]
    
    data <- data[data$date >= start_date & data$date < end_date, ]
    print(nrow(data))
    avgSolar[[i]] = mean(data$`NG: SUN`, na.rm=TRUE)
    print(paste("avgSolar for ",country, " = ", avgSolar[[i]], sep=""))
  }
  return (array(unlist(avgSolar)))
}

```

```{r}
library(sf)
plot_data <- readRDS("../plot_data/eia_region_polygons.rds")
plot_data["solar"] = findAvgSolar("2018-07-01","2023-06-13")
ggplot(plot_data, aes(fill=solar),color =NA,size=0.5,alpha=1) + geom_sf() +  scale_fill_viridis_c(option = "B")
```